{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the Danny Store application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "displayName": {
          "type": "string",
          "description": "User's display name."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "photoURL": {
          "type": "string",
          "description": "URL of the user's profile picture.",
          "format": "uri"
        },
        "language": {
          "type": "string",
          "description": "User's preferred language (en, fr, ht)."
        },
        "phoneWhatsApp": {
          "type": "string",
          "description": "User's WhatsApp phone number."
        },
        "consentWhatsApp": {
          "type": "boolean",
          "description": "Indicates if the user has consented to be contacted via WhatsApp."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the user account was created.",
          "format": "date-time"
        },
        "lastLoginAt": {
          "type": "string",
          "description": "Timestamp of the user's last login.",
          "format": "date-time"
        },
        "isAdmin": {
          "type": "boolean",
          "description": "Indicates if the user is an administrator."
        },
        "roles": {
          "type": "array",
          "description": "List of roles assigned to the user.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "displayName",
        "email",
        "language",
        "phoneWhatsApp",
        "consentWhatsApp",
        "createdAt",
        "lastLoginAt"
      ]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "type": "object",
      "description": "Represents a role with associated permissions.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the role entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the role."
        },
        "permissions": {
          "type": "array",
          "description": "List of permissions associated with the role.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "permissions"
      ]
    },
    "Product": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Product",
      "type": "object",
      "description": "Represents a product in the Danny Store catalog.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the product entity."
        },
        "slug": {
          "type": "string",
          "description": "Unique slug for the product (used in URLs)."
        },
        "title": {
          "type": "string",
          "description": "Title of the product."
        },
        "descriptions": {
          "type": "string",
          "description": "Description for the product."
        },
        "price": {
          "type": "number",
          "description": "Price of the product."
        },
        "compareAtPrice": {
          "type": "number",
          "description": "Original price of the product (used for displaying discounts)."
        },
        "images": {
          "type": "array",
          "description": "List of image URLs for the product.",
          "items": {
            "type": "string"
          }
        },
        "categoryId": {
          "type": "string",
          "description": "Reference to Category. (Relationship: Category 1:N Product)"
        },
        "tags": {
          "type": "array",
          "description": "List of tags associated with the product.",
          "items": {
            "type": "string"
          }
        },
        "variants": {
          "type": "array",
          "description": "List of product variants (color, size, etc.).",
          "items": {
            "type": "string"
          }
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates if the product is currently active and visible."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the product was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the product was last updated.",
          "format": "date-time"
        },
        "ratingAvg": {
          "type": "number",
          "description": "Average rating of the product."
        },
        "ratingCount": {
          "type": "number",
          "description": "Number of ratings for the product."
        }
      },
      "required": [
        "id",
        "slug",
        "title",
        "descriptions",
        "price",
        "images",
        "categoryId",
        "variants",
        "isActive",
        "createdAt",
        "updatedAt",
        "ratingAvg",
        "ratingCount"
      ]
    },
    "Category": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Category",
      "type": "object",
      "description": "Represents a product category.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the category entity."
        },
        "slug": {
          "type": "string",
          "description": "Unique slug for the category (used in URLs)."
        },
        "name": {
          "type": "string",
          "description": "Name of the category."
        },
        "order": {
          "type": "number",
          "description": "Order of the category in the category list."
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates if the category is currently active and visible."
        },
        "attributesConfig": {
          "type": "string",
          "description": "Configuration for customizable category attributes (sizes, colors, filters)."
        }
      },
      "required": [
        "id",
        "slug",
        "name",
        "order",
        "isActive",
        "attributesConfig"
      ]
    },
    "Collection": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Collection",
      "type": "object",
      "description": "Represents a collection of products.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the collection entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the collection."
        },
        "productIds": {
          "type": "array",
          "description": "References to Products. (Relationship: Collection N:N Product)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "productIds"
      ]
    },
    "Page": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Page",
      "type": "object",
      "description": "Represents a CMS page (about, FAQ, legal).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the page entity."
        },
        "title": {
          "type": "string",
          "description": "Title of the page."
        },
        "content": {
          "type": "string",
          "description": "Content of the page (HTML or markdown)."
        }
      },
      "required": [
        "id",
        "title",
        "content"
      ]
    },
    "SiteSetting": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SiteSetting",
      "type": "object",
      "description": "Represents global site settings.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for site settings. Should be 'global'."
        },
        "themeTokens": {
          "type": "string",
          "description": "Theme tokens (light/dark)."
        },
        "socialLinks": {
          "type": "string",
          "description": "Social media links."
        },
        "whatsappSupportNumber": {
          "type": "string",
          "description": "WhatsApp support phone number."
        },
        "languagesEnabled": {
          "type": "string",
          "description": "List of enabled languages (en, fr, ht)."
        },
        "seoDefaults": {
          "type": "string",
          "description": "Default SEO settings."
        },
        "featureFlags": {
          "type": "string",
          "description": "Feature flags."
        }
      },
      "required": [
        "id",
        "themeTokens",
        "socialLinks",
        "whatsappSupportNumber",
        "languagesEnabled",
        "seoDefaults",
        "featureFlags"
      ]
    },
    "Cart": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Cart",
      "type": "object",
      "description": "Represents a user's shopping cart.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 Cart)"
        },
        "items": {
          "type": "array",
          "description": "List of items in the cart.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "userId",
        "items"
      ]
    },
    "Order": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Order",
      "type": "object",
      "description": "Represents a customer order.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the order entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Order)"
        },
        "items": {
          "type": "array",
          "description": "List of items in the order.",
          "items": {
            "type": "string"
          }
        },
        "subtotal": {
          "type": "number",
          "description": "Subtotal of the order."
        },
        "total": {
          "type": "number",
          "description": "Total amount of the order."
        },
        "currency": {
          "type": "string",
          "description": "Currency of the order."
        },
        "status": {
          "type": "string",
          "description": "Status of the order (pending, confirmed, processing, shipped, delivered, cancelled)."
        },
        "checkoutMethod": {
          "type": "string",
          "description": "Checkout method used (whatsapp, other)."
        },
        "customerWhatsApp": {
          "type": "string",
          "description": "Customer's WhatsApp number used for the order."
        },
        "language": {
          "type": "string",
          "description": "Language used for the order (en, fr, ht)."
        },
        "provisionalWhatsAppMessage": {
          "type": "string",
          "description": "Provisional WhatsApp message generated for the order."
        },
        "deliveryNote": {
          "type": "string",
          "description": "Delivery note for the order."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the order was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the order was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "items",
        "subtotal",
        "total",
        "currency",
        "status",
        "checkoutMethod",
        "customerWhatsApp",
        "language",
        "provisionalWhatsAppMessage",
        "deliveryNote",
        "createdAt",
        "updatedAt"
      ]
    },
    "OrderEvent": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OrderEvent",
      "type": "object",
      "description": "Represents an event in the lifecycle of an order.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the event entity."
        },
        "orderId": {
          "type": "string",
          "description": "Reference to Order. (Relationship: Order 1:N OrderEvent)"
        },
        "type": {
          "type": "string",
          "description": "Type of event (e.g., status change)."
        },
        "message": {
          "type": "string",
          "description": "Message associated with the event."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the event occurred.",
          "format": "date-time"
        },
        "actor": {
          "type": "string",
          "description": "Actor who triggered the event (admin/user)."
        }
      },
      "required": [
        "id",
        "orderId",
        "type",
        "message",
        "createdAt",
        "actor"
      ]
    },
    "Review": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Review",
      "type": "object",
      "description": "Represents a product review.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the review entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Review)"
        },
        "productId": {
          "type": "string",
          "description": "Reference to Product. (Relationship: Product 1:N Review)"
        },
        "orderId": {
          "type": "string",
          "description": "Reference to Order. (Relationship: Order 1:N Review)"
        },
        "rating": {
          "type": "number",
          "description": "Rating given by the user (1-5)."
        },
        "text": {
          "type": "string",
          "description": "Text of the review."
        },
        "status": {
          "type": "string",
          "description": "Status of the review (published, hidden, pending)."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the review was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the review was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "productId",
        "rating",
        "text",
        "status",
        "createdAt",
        "updatedAt"
      ]
    },
    "SurveyPrompt": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SurveyPrompt",
      "type": "object",
      "description": "Represents a survey prompt displayed to the user after an order is delivered.",
      "properties": {
        "orderId": {
          "type": "string",
          "description": "Reference to Order. (Relationship: Order 1:1 SurveyPrompt)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 SurveyPrompt)"
        },
        "status": {
          "type": "string",
          "description": "Status of the survey (idle, snoozed, submitted)."
        },
        "shownOnce": {
          "type": "boolean",
          "description": "Indicates if the survey has been shown to the user once."
        },
        "reshowAt": {
          "type": "string",
          "description": "Timestamp of when the survey should be shown again if snoozed.",
          "format": "date-time"
        },
        "submittedAt": {
          "type": "string",
          "description": "Timestamp of when the survey was submitted.",
          "format": "date-time"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the survey prompt was created.",
          "format": "date-time"
        }
      },
      "required": [
        "orderId",
        "userId",
        "status",
        "shownOnce",
        "reshowAt",
        "createdAt"
      ]
    },
    "TryonUsage": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TryonUsage",
      "type": "object",
      "description": "Represents the usage of virtual try-on feature for a user on a specific day.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N TryonUsage)"
        },
        "date": {
          "type": "string",
          "description": "Date for which the try-on usage is recorded (YYYYMMDD)."
        },
        "usedCount": {
          "type": "number",
          "description": "Number of try-on requests used on the specified date."
        },
        "limit": {
          "type": "number",
          "description": "Maximum number of try-on requests allowed per day (default 5)."
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the try-on usage was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "userId",
        "date",
        "usedCount",
        "limit",
        "updatedAt"
      ]
    },
    "TryonRequest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TryonRequest",
      "type": "object",
      "description": "Represents a request for a virtual try-on.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the try-on request entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N TryonRequest)"
        },
        "avatarId": {
          "type": "string",
          "description": "Identifier of the avatar used for the try-on."
        },
        "itemsSnapshot": {
          "type": "string",
          "description": "Snapshot of the items used for the try-on."
        },
        "userPhotoUrl": {
          "type": "string",
          "description": "URL of the user's photo used for the try-on.",
          "format": "uri"
        },
        "status": {
          "type": "string",
          "description": "Status of the try-on request (queued, processing, done, error)."
        },
        "resultImageUrl": {
          "type": "string",
          "description": "URL of the resulting image after the try-on is processed.",
          "format": "uri"
        },
        "errorMessage": {
          "type": "string",
          "description": "Error message if the try-on request failed."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the try-on request was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp of when the try-on request was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "avatarId",
        "itemsSnapshot",
        "status",
        "createdAt",
        "updatedAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. Only the user can read/write their own document (except admin fields). Includes isAdmin and roles[] for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "roles/{roleId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Stores role definitions (name, permissions[]). Accessible to super admins only.",
          "params": [
            {
              "name": "roleId",
              "description": "The unique identifier of the role."
            }
          ]
        }
      },
      {
        "path": "products/{productId}",
        "definition": {
          "entityName": "Product",
          "schema": {
            "$ref": "#/backend/entities/Product"
          },
          "description": "Stores product information. Public read for active products (isActive=true). Admin write access via server.",
          "params": [
            {
              "name": "productId",
              "description": "The unique identifier of the product."
            }
          ]
        }
      },
      {
        "path": "categories/{categoryId}",
        "definition": {
          "entityName": "Category",
          "schema": {
            "$ref": "#/backend/entities/Category"
          },
          "description": "Stores product categories. Public read. Admin write access via server.",
          "params": [
            {
              "name": "categoryId",
              "description": "The unique identifier of the category."
            }
          ]
        }
      },
      {
        "path": "collections/{collectionId}",
        "definition": {
          "entityName": "Collection",
          "schema": {
            "$ref": "#/backend/entities/Collection"
          },
          "description": "Stores collections of products. Public read. Admin write access via server.",
          "params": [
            {
              "name": "collectionId",
              "description": "The unique identifier of the collection."
            }
          ]
        }
      },
      {
        "path": "pages/{pageId}",
        "definition": {
          "entityName": "Page",
          "schema": {
            "$ref": "#/backend/entities/Page"
          },
          "description": "Stores CMS pages (about, FAQ, legal). Public read. Admin write access via server.",
          "params": [
            {
              "name": "pageId",
              "description": "The unique identifier of the page."
            }
          ]
        }
      },
      {
        "path": "siteSettings/global",
        "definition": {
          "entityName": "SiteSetting",
          "schema": {
            "$ref": "#/backend/entities/SiteSetting"
          },
          "description": "Stores global site settings. Public read. Admin write access via server.",
          "params": []
        }
      },
      {
        "path": "carts/{userId}",
        "definition": {
          "entityName": "Cart",
          "schema": {
            "$ref": "#/backend/entities/Cart"
          },
          "description": "Stores user's shopping cart.  The user can read/write their own cart. Uses userId in document ID.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "orders/{orderId}",
        "definition": {
          "entityName": "Order",
          "schema": {
            "$ref": "#/backend/entities/Order"
          },
          "description": "Stores customer orders. User can read their own orders. Write access only via server (or strict rules). Includes userId for authorization independence.",
          "params": [
            {
              "name": "orderId",
              "description": "The unique identifier of the order."
            }
          ]
        }
      },
      {
        "path": "orderEvents/{orderId}/events/{eventId}",
        "definition": {
          "entityName": "OrderEvent",
          "schema": {
            "$ref": "#/backend/entities/OrderEvent"
          },
          "description": "Stores events related to an order. Write access only via server (admin).",
          "params": [
            {
              "name": "orderId",
              "description": "The unique identifier of the order."
            },
            {
              "name": "eventId",
              "description": "The unique identifier of the event."
            }
          ]
        }
      },
      {
        "path": "reviews/{reviewId}",
        "definition": {
          "entityName": "Review",
          "schema": {
            "$ref": "#/backend/entities/Review"
          },
          "description": "Stores product reviews. Public read only for published reviews. User can write their own reviews (if authorized). Includes userId, productId, orderId. Status (published, hidden, pending).",
          "params": [
            {
              "name": "reviewId",
              "description": "The unique identifier of the review."
            }
          ]
        }
      },
      {
        "path": "surveyPrompts/{orderId}",
        "definition": {
          "entityName": "SurveyPrompt",
          "schema": {
            "$ref": "#/backend/entities/SurveyPrompt"
          },
          "description": "Stores survey prompts displayed after an order is delivered. One per order. Write access via server. Includes userId, orderId, status (idle, snoozed, submitted).",
          "params": [
            {
              "name": "orderId",
              "description": "The unique identifier of the order (and related order)."
            }
          ]
        }
      },
      {
        "path": "tryonUsage/{userId}/days/{YYYYMMDD}",
        "definition": {
          "entityName": "TryonUsage",
          "schema": {
            "$ref": "#/backend/entities/TryonUsage"
          },
          "description": "Stores usage of the virtual try-on feature per user per day. Write access via server. Uses userId, date, usedCount, limit.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "YYYYMMDD",
              "description": "The date in YYYYMMDD format."
            }
          ]
        }
      },
      {
        "path": "tryonRequests/{requestId}",
        "definition": {
          "entityName": "TryonRequest",
          "schema": {
            "$ref": "#/backend/entities/TryonRequest"
          },
          "description": "Stores requests for virtual try-on. User can read their own requests. Write access via server. Includes userId, avatarId, itemsSnapshot, status.",
          "params": [
            {
              "name": "requestId",
              "description": "The unique identifier of the try-on request."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to ensure security, scalability, and ease of debugging, adhering to the core design principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). Authorization Independence is achieved through denormalization, specifically by including authorization-related fields (like `isAdmin`, `roles` for users, `userId` in orders, and denormalizing product details into order items) directly within the documents that require them, avoiding the need for `get()` calls in security rules.\n\nStructural Segregation is applied by separating data with different access needs into distinct collections (e.g., public products, user-specific orders, admin-managed roles). This simplifies security rules by ensuring a homogeneous security posture within each collection. Access Modeling follows a consistent pattern: user-owned data is stored in hierarchical paths (`/users/{userId}/orders/{orderId}`), collaborative data leverages the Membership Map pattern (although not explicitly used here, it's the recommended approach for collections needing collaborative access, if any), and global roles are managed via existence in dedicated collections (`/roles/{roleId}`).\n\nTo facilitate secure `list` operations (QAPs), public data (`products` where `isActive=true`, `categories`, `collections`, `pages`) is segregated from private data, and list access to user-specific data is controlled via path-based rules (e.g., only the user can list their own orders).  Admin access is determined by their roles, which are checked on the backend before data modification.\n\nThe chosen structure supports the integrity of ownership, timestamps, and denormalized data by enforcing strict server-side validation using Zod, ensuring that critical operations are performed securely and consistently. Timestamps (`createdAt`, `updatedAt`) maintain data lineage and aid in debugging."
  }
}