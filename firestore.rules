rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset enforces a strict user-ownership model for
     * private data (user profiles, orders) and a "public read, owner-only write"
     * model for semi-public data (reviews). The product catalog is treated as
     * public, read-only data, intended to be managed by a trusted backend server
     * rather than directly by clients.
     *
     * Data Structure:
     * - /users/{userId} -> Private user profiles and nested private collections.
     * - /users/{userId}/orders/{orderId} -> User's private order history.
     * - /products/{productId} -> Public product catalog.
     * - /products/{productId}/reviews/{reviewId} -> Public reviews for a product.
     *
     * Key Security Decisions:
     * - User data is strictly private. A user can only access documents within
     *   their own `/users/{userId}` data tree.
     * - User enumeration is disallowed by restricting `list` on the `/users` collection.
     * - The product catalog (`/products` and subcollections) is publicly readable but
     *   is not writable by any client. This is a secure default, assuming product
     *   management is handled by an admin SDK on a server.
     * - Reviews are publicly readable, but can only be created, updated, or deleted
     *   by the authenticated user who authored them.
     *
     * Denormalization for Authorization:
     * - The `/products/{productId}/reviews/{reviewId}` documents contain a `userId`
     *   field. This is essential for authorizing updates and deletes, as it allows
     *   a fast check against the existing document's data without extra reads.
     *
     * Structural Segregation:
     * - Private data (orders) is nested under a user's document, clearly separating it
     *   from public data (products) which resides in a top-level collection. This
     *   simplifies rules and improves query performance and security.
     */

    // --------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the given userId.
     * This is the primary function for enforcing data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if a document exists before an update or delete operation.
     * This is crucial for preventing writes on non-existent documents.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * A convenient combination of isOwner and isExistingDoc for update/delete rules.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    // --------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------

    /**
     * @description Manages user profile documents. A user can create their own
     *              profile and can only read or update their own data.
     * @path /users/{userId}
     * @allow (create) a user with auth.uid 'user123' on path `/users/user123`.
     * @deny  (get) a user with auth.uid 'user456' on path `/users/user123`.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if false;

      /**
       * @description Manages a user's private order history. Only the owner can
       *              access or modify their orders.
       * @path /users/{userId}/orders/{orderId}
       * @allow (get) a user with auth.uid 'user123' on path `/users/user123/orders/orderABC`.
       * @deny  (list) a user with auth.uid 'user456' on path `/users/user123/orders`.
       * @principle Enforces document ownership for all operations.
       */
      match /orders/{orderId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);

        /**
         * @description Manages the specific items within an order. Access rules are
         *              inherited from the parent user-owned path.
         * @path /users/{userId}/orders/{orderId}/items/{itemId}
         * @allow (create) a user with auth.uid 'user123' on path `/users/user123/orders/orderABC/items/itemXYZ`.
         * @deny  (get) a user with auth.uid 'user456' on path `/users/user123/orders/orderABC/items/itemXYZ`.
         * @principle Access is inherited from the parent user-owned data tree.
         */
        match /items/{itemId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.orderId == orderId;
          allow update: if isExistingOwner(userId) && request.resource.data.orderId == resource.data.orderId;
          allow delete: if isExistingOwner(userId);
        }
      }
    }

    /**
     * @description The public product catalog. All users (including unauthenticated ones)
     *              can read products. All writes are disallowed from the client.
     * @path /products/{productId}
     * @allow (get) any user, authenticated or not, on path `/products/prodABC`.
     * @deny  (create) any user attempting to add a new product.
     * @principle Public read-only data, managed by a backend.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;

      /**
       * @description Product variants. Publicly readable, not client-writable.
       * @path /products/{productId}/variants/{variantId}
       * @allow (list) any user on path `/products/prodABC/variants`.
       * @deny  (update) any user attempting to change a variant's price.
       * @principle Public read-only data, managed by a backend.
       */
      match /variants/{variantId} {
        allow get: if true;
        allow list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Publicly readable product reviews. Signed-in users can create
       *              reviews, and can only modify or delete their own.
       * @path /products/{productId}/reviews/{reviewId}
       * @allow (create) a signed-in user on path `/products/prodABC/reviews/rev123` if the review data includes their own UID.
       * @deny  (delete) a user with auth.uid 'user456' on a review where `resource.data.userId` is 'user123'.
       * @principle Public read with owner-only writes.
       */
      match /reviews/{reviewId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid && request.resource.data.productId == productId;
        allow update: if isExistingDoc() && isOwner(resource.data.userId) && request.resource.data.userId == resource.data.userId && request.resource.data.productId == resource.data.productId;
        allow delete: if isExistingDoc() && isOwner(resource.data.userId);
      }
    }
  }
}