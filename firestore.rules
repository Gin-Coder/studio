rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Check if the user has a specific role
    function hasRole(role) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny([role, 'super_admin']);
    }
    
    // Check if user has a specific permission by checking all their roles
    function hasPermission(permission) {
        let userRoles = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
        // Early exit for super_admin
        if ('super_admin' in userRoles) {
          return true;
        }
        // Iterate through user roles and check permissions
        let isAllowed = false;
        for (let roleName in userRoles) {
            let roleDoc = get(/databases/$(database)/documents/roles/$(userRoles[roleName])).data;
            if (permission in roleDoc.permissions || '*' in roleDoc.permissions) {
                isAllowed = true;
                break;
            }
        }
        return isAllowed;
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------

    // Users
    // Users can read their own data.
    // Users can update their own data, but not their roles or isAdmin status.
    // Admins with 'users.read' can read any user doc.
    // Admins with 'users.write' can update any user doc (incl. roles).
    match /users/{userId} {
      allow get: if isOwner(userId) || hasPermission('users.read');
      allow list: if hasPermission('users.read');
      allow create: if isOwner(userId); // Any authenticated user can create their own profile
      allow update: if (isOwner(userId) && !("roles" in request.resource.data) && !("isAdmin" in request.resource.data)) || hasPermission('users.write');
      allow delete: if hasPermission('users.write'); // Only admins can delete users
    }

    // Roles
    // Only readable and writable by users with 'roles.assign' permission (typically super_admins).
    match /roles/{roleId} {
      allow read, write: if hasPermission('roles.assign');
    }

    // Products, Categories, Collections, Pages
    // Publicly readable if 'isActive' is true.
    // Writable only by users with the appropriate admin permissions.
    match /products/{productId} {
      allow get: if resource.data.isActive == true;
      allow list: if true; // Client must filter for isActive=true
      allow write: if hasPermission('products.write');
    }

    match /categories/{categoryId} {
      allow read: if true;
      allow write: if hasPermission('categories.write');
    }
    
    match /collections/{collectionId} {
      allow read: if true;
      allow write: if hasPermission('collections.write');
    }

    match /pages/{pageId} {
      allow read: if true;
      allow write: if hasPermission('content_seo');
    }
    
    // Site Settings
    // Publicly readable, but only writable by admins with content_seo permission.
     match /siteSettings/global {
      allow read: if true;
      allow write: if hasPermission('content_seo');
    }

    // Carts
    // Only the owner of the cart can read or write to it.
    match /carts/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Orders
    // Users can read their own orders. List operations must be filtered by userId.
    // Writes are only allowed from the server (or by an order manager).
    match /orders/{orderId} {
      allow get: if isOwner(resource.data.userId) || hasPermission('orders.read');
      allow list: if hasPermission('orders.read') || request.query.userId == request.auth.uid;
      allow create: if isSignedIn(); // Allow any signed-in user to create an order via server action
      allow update: if hasPermission('orders.write'); // Only admins can update
      allow delete: if false; // Orders should not be deletable
    }
    
    // Order Events
    // Readable by the order owner or an admin. Writable only by server/admins.
    match /orderEvents/{orderId}/events/{eventId} {
      allow read: if get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid || hasPermission('orders.read');
      allow write: if hasPermission('orders.write');
    }
    
    // Reviews
    // Published reviews are public. Users can create/update/delete their own reviews.
    // Admins with 'reviews.moderate' can write/delete any review.
    match /reviews/{reviewId} {
      allow get: if resource.data.status == 'published' || isOwner(resource.data.userId) || hasPermission('reviews.read');
      allow list: if true; // Client must filter for status=='published'
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId) || hasPermission('reviews.moderate');
      allow write: if hasPermission('reviews.moderate'); // Moderator can edit anything
    }

    // Survey Prompts
    // Readable by the owner or an admin. Writable only by the server.
    match /surveyPrompts/{orderId} {
       allow get: if isOwner(resource.data.userId) || hasPermission('orders.read');
       allow write: if false; // Server-only writes
    }
    
    // Tryon Usage and Requests
    // Readable only by the owner or an admin. Writable only by the server.
    match /tryonUsage/{userId}/days/{YYYYMMDD} {
      allow get: if isOwner(userId) || hasPermission('users.read');
      allow write: if false; // Server-only writes
    }

    match /tryonRequests/{requestId} {
      allow get: if isOwner(resource.data.userId) || hasPermission('users.read');
      allow list: if request.query.userId == request.auth.uid || hasPermission('users.read');
      allow write: if false; // Server-only writes
    }
  }
}
